---
git: eb80ae09e91fa364dc1719f928a47a7a1ec36212
---

# Руководство по обновлению

<a name="high-impact-changes"></a>
## Изменения, оказывающие большое влияние

<!-- <div class="content-list" markdown="1"> -->

- [Обновление зависимостей](#updating-dependencies)
- [Обновление минимальной стабильности](#updating-minimum-stability)

<!-- </div> -->

<a name="medium-impact-changes"></a>
## Изменения со средней степенью воздействия

<!-- <div class="content-list" markdown="1"> -->

- [Выражения базы данных](#database-expressions)
- [Свойство "Dates" модели](#model-dates-property)
- [Monolog 3](#monolog-3)
- [Теги кэша Redis](#redis-cache-tags)
- [Сервис Mocking](#service-mocking)
- [Каталог языка](#language-directory)

<!-- </div> -->

<a name="low-impact-changes"></a>
###### Изменения с низким уровнем воздействия

<!-- <div class="content-list" markdown="1"> -->

- [Сообщения правила валидации на основе замыкания ](#closure-validation-rule-messages)
- [Метод `after` запроса формы](#form-request-after-method)
- [Привязка публичного пути](#public-path-binding)
- [Конструктор исключения запроса](#query-exception-constructor)
- [Возвращаемое значение Rate Limiter](#rate-limiter-return-values)
- [Метод `Redirect::home`](#redirect-home)
- [Метод`Bus::dispatchNow`](#dispatch-now)
- [Метод`registerPolicies`](#register-policies)
- [ULID столбцы](#ulid-columns)

<!-- </div> -->


<a name="upgrade-10.0"></a>
## Обновление с 9.x версии до 10.0

<a name="estimated-upgrade-time-??-minutes"></a>
#### Приблизительное время обновления: 10 минут

> [!NOTE]
> Мы стараемся задокументировать каждое возможное изменение, которое может привести к нарушению совместимости. Поскольку некоторые из этих критических изменений находятся в малоизвестных частях фреймворка, только часть этих изменений может повлиять на ваше приложение. Хотите сэкономить время? Вы можете использовать [Laravel Shift](https://laravelshift.com/) , чтобы автоматизировать процесс обновления вашего приложения.

<a name="updating-dependencies"></a>
### Обновление зависимостей

**Вероятность воздействия: высокая**

<a name="php-7.3.0-required"></a>
#### Требуется PHP 8.1.0

Laravel теперь требует PHP версии 8.1.0 или выше.

#### Требуется Composer 2.2.0

Laravel теперь требует Composer 2.2.0 или выше.

#### Зависимости Composer

Обновите следующие зависимости в вашем файле `composer.json`:

<!-- <div class="content-list" markdown="1"> -->

- `laravel/framework` до `^10.0`
- `laravel/sanctum` до `^3.2`
- `doctrine/dbal` до `^3.0`
- `spatie/laravel-ignition` до `^2.0`
- `laravel/passport` до `^11.0` ([Руководство по обновлению](https://github.com/laravel/passport/blob/11.x/UPGRADE.md))

<!-- </div> -->

Если вы обновляете Sanctum с 2.x до 3.x из релиза 2.x, пожалуйста, ознакомьтесь с [руководством по обновлению Sanctum](https://github.com/laravel/sanctum/blob/3.x/UPGRADE.md).

Кроме того, если вы хотите использовать PHPUnit 10, вам следует удалить атрибут `processUncoveredFiles` из раздела `<coverage>` файла `phpunit.xml`. Затем обновите следующие зависимости в файле `composer.json` вашего приложения:

<!-- <div class="content-list" markdown="1"> -->

- `nunomaduro/collision` to `^7.0`
- `phpunit/phpunit` to `^10.0`

<!-- </div> -->

И, наконец, рассмотрите другие сторонние пакеты, используемые вашим приложением, и убедитесь, что вы используете подходящую для Laravel 10 версию.


<a name="updating-minimum-stability"></a>
#### Минимальная стабильность

Вам следует обновить параметр `minimum-stability` в файле `composer.json` вашего приложения на значение `stable`. Или, поскольку значение `minimum-stability` по умолчанию равно `stable`, вы можете удалить этот параметр из файла `composer.json`:

```json
"minimum-stability": "stable",
```

### Приложение

<a name="public-path-binding"></a>
#### Привязка публичного пути

**Вероятность воздействия: Низкая**

Если ваше приложение настраивает свой «публичный путь», привязывая `path.public` к контейнеру, вместо этого вам следует обновить ваш код и использовать метод `usePublicPath`, предлагаемый объектом `Illuminate\Foundation\Application`:

```php
app()->usePublicPath(__DIR__.'/public');
```

### Авторизация

<a name="register-policies"></a>
### Метод `registerPolicies`

**Вероятность воздействия: Низкая**

Метод `registerPolicies` в `AuthServiceProvider` теперь вызывается фреймворком автоматически. Следовательно, вы можете удалить его вызов из метода `boot` в `AuthServiceProvider` вашего приложения.

### Кеш

<a name="redis-cache-tags"></a>
#### Теги кэша Redis

**Вероятность воздействия: Средняя**

Использование `Cache::tags()` рекомендуется только для приложений, использующих Memcached. Если вы используете Redis в качестве драйвера кэша вашего приложения, рассмотрите возможность перехода на Memcached или использование альтернативного решения.

### База данных

**Вероятность воздействия: Средняя**

<a name="database-expressions"></a>
#### Выражения базы данных

В Laravel 10.x выражения базы данных (обычно генерируемые `через DB::raw`) были переписаны для предоставления дополнительной функциональности в будущем. Важно отметить, что сырое строковое значение грамматики теперь должно быть получено через метод `getValue(Grammar $grammar)` выражения. Приведение выражения к строке с использованием `(string)` больше не поддерживается.

Обычно это не влияет на конечных пользователей приложения; однако, если ваше приложение вручную приводит выражения базы данных к строкам, используя `(string)` или вызывает метод `__toString` напрямую у выражения, вам следует обновить ваш код и вместо этого использовать метод `getValue`:

```php
use Illuminate\Support\Facades\DB;

$expression = DB::raw('select 1');

$string = $expression->getValue(DB::connection()->getQueryGrammar());
```


<a name="query-exception-constructor"></a>
#### Конструктор исключения запроса

**Вероятность воздействия: Очень низкая**

Конструктор `Illuminate\Database\QueryException` теперь принимает строку с именем подключения в качестве своего первого аргумента. Если ваше приложение вручную вызывает это исключение, вам следует соответственно изменить свой код.

<a name="ulid-columns"></a>
#### ULID столбцы

**Вероятность воздействия: Низкая**

При использовании в миграциях метода `ulid` без аргументов, столбец теперь будет назван `ulid`. В предыдущих версиях Laravel, вызов этого метода без аргументов ошибочно создавал столбец с именем `uuid`:

    $table->ulid();

Вы можете явно указать имя столбца при вызове метода `ulid`, передав имя столбца:

    $table->ulid('ulid');


### Eloquent

<a name="model-dates-property"></a>
#### Свойство "Dates" модели

**Вероятность воздействия: Средняя**

Устаревшее свойство `$dates` в Eloquent-модели было удалено. Теперь ваше приложение должно использовать свойство `$casts`:

```php
protected $casts = [
    'deployed_at' => 'datetime',
];
```


### Локализация

<a name="language-directory"></a>
#### Каталог языка

**Вероятность воздействия: Нет**

Хотя это не имеет отношения к существующим приложениям, стандартная структура приложения Laravel теперь по умолчанию не включает директорию `lang`. Вместо этого, при написании новых приложений Laravel ее можно опубликовать с использованием команды Artisan `lang:publish`:

```shell
php artisan lang:publish
```

### Логирование

<a name="monolog-3"></a>
#### Monolog 3

**Вероятность воздействия: Средняя**

Зависимость Laravel от Monolog была обновлена до версии Monolog 3.x. Если вы напрямую взаимодействуете с Monolog в вашем приложении, вам следует ознакомиться с [руководством по обновлению Monolog](https://github.com/Seldaek/monolog/blob/main/UPGRADE.md).

Если вы используете сторонние службы ведения журнала, такие как BugSnag или Rollbar, вам может потребоваться обновить эти сторонние пакеты до версии, поддерживающей Monolog 3.x и Laravel 10.x.

### Очереди

<a name="dispatch-now"></a>
#### Метод `Bus::dispatchNow`

**Вероятность воздействия: Низкая**


Устаревшие методы `Bus::dispatchNow` и `dispatch_now` были удалены. Вместо них ваше приложение должно использовать методы `Bus::dispatchSync` и `dispatch_sync` соответственно.


<a name="dispatch-return"></a>

#### Возвращаемое значение помощника `dispatch()`

**Вероятность воздействия: Низкая**

Вызов `dispatch` с классом, который не реализует `Illuminate\Contracts\Queue`, ранее возвращал результат метода `handle` этого класса. Однако теперь это будет возвращён экземпляр `Illuminate\Foundation\Bus\PendingBatch`. Вы можете использовать `dispatch_sync()` чтобы вернуться к предыдущему поведению.

### Маршрутизация

<a name="middleware-aliases"></a>
#### Псевдонимы Middleware

**Вероятность воздействия: Опционально**

В новых приложениях Laravel свойство `$routeMiddleware` класса `App\Http\Kernel` было переименовано в `$middlewareAliases` для более точного отражения его назначения. Вы можете переименовать это свойство в ваших существующих приложениях; однако это не обязательно.

#### Возвращаемое значение Rate Limiter

**Вероятность воздействия: Низкая**

При вызове метода `RateLimiter::attempt` значение, возвращаемое предоставленным замыканием, будет также возвращено самим методом. Если возвращаемое значение - `null` или отсутствует, метод `attempt` вернет `true`:

```php
$value = RateLimiter::attempt('key', 10, fn () => ['example'], 1);

$value; // ['example']
```

<a name="redirect-home"></a>
#### Метод `Redirect::home` 

**Вероятность воздействия: Очень низкая**

Устаревший метод Redirect::home был удален. Вместо этого ваше приложение должно выполнять перенаправление на явно указанный маршрут:

```php
return Redirect::route('home');
```

### Тестирование

<a name="service-mocking"></a>
#### Сервис Mocking

**Вероятность воздействия: Средняя**


Устаревший трейт `MocksApplicationServices` был удален из фреймворка. Этот трейт предоставлял методы тестирования, такие как `expectsEvents`, `expectsJobs` и `expectsNotifications`.

Если ваше приложение использует эти методы, мы рекомендуем переходить к использованию методов `Event::fake`, `Bus::fake` и `Notification::fake` соответственно. Вы можете узнать больше о подражании с помощью подделок в соответствующей документации для компонента, который вы пытаетесь фальсифицировать.

### Валидация

<a name="closure-validation-rule-messages"></a>
#### Сообщения правила валидации на основе замыкания

**Вероятность воздействия: Очень низкая**

При написании пользовательских правил валидации на основе замыканий, вызов `$fail` более одного раза теперь добавит сообщения в массив, а не перезапишет предыдущее сообщение. Скорее всего это не повлияет на ваше приложение.

Кроме того, коллбэк `$fail` теперь возвращает объект. Если вы ранее указывали тип возвращаемого значения в замыкании валидации, это может потребовать обновления вашего типа:

```php
public function rules()
{
    'name' => [
        function ($attribute, $value, $fail) {
            $fail('validation.translation.key')->translate();
        },
    ],
}
```

<a name="validation-messages-and-closure-rules"></a>
#### Сообщения о валидации и правила на основе замыканий

**Вероятность воздействия: Очень низкая**

Ранее вы могли назначить сообщение об ошибке другому ключу, предоставив массив в `$fail` в правилах валидации на основе замыканий. Однако теперь вы должны предоставить ключ в качестве первого аргумента, а сообщение об ошибке - в качестве второго аргумента:

```php
Validator::make([
    'foo' => 'string',
    'bar' => [function ($attribute, $value, $fail) {
        $fail('foo', 'Something went wrong!');
    }],
]);
```

<a name="form-request-after-method"></a>
#### Метод after запроса формы

**Вероятность воздействия: Очень низкая**
 
 Метод `after` внутри запросов формы теперь [зарезервирован Laravel](https://github.com/laravel/framework/pull/46757).

Если в ваших запросах формы определён метод `after`, этот метод следует переименовать или изменить, чтобы использовать новую функциональность "после валидации" в запросах формы Laravel.

<a name="miscellaneous"></a>
### Разное

Мы также рекомендуем вам просматривать изменения в GitHub-репозитории [`laravel/laravel`](https://github.com/laravel/laravel). Хотя многие из этих изменений могут быть неважны, но вы можете синхронизировать эти файлы с вашим приложением. Некоторые из этих изменений будут рассмотрены в данном руководстве по обновлению, но другие, такие как изменения файлов конфигурации или комментарии, не будут. 

Вы можете легко просмотреть изменения с помощью [инструмента сравнения GitHub](https://github.com/laravel/laravel/compare/9.x...10.x) и выбрать, какие обновления важны для вас. Тем не менее, многие изменения, показанные инструментом сравнения GitHub, связаны с принятием нативных типов PHP в нашей организации. Эти изменения обратно совместимы, и их принятие во время миграции на Laravel 10 является необязательным.

